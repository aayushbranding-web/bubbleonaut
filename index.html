<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bubbleonaut: AyTech Solution</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        body {
            margin: 0;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            font-family: 'Fredoka One', cursive;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw; height: 100vh;
            background: radial-gradient(circle at center, #2a003d 0%, #000011 100%);
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; pointer-events: none; z-index: 10;
        }

        .hud-text {
            color: #fff; font-size: 18px;
            text-shadow: 2px 2px 0px #00aaff;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px; border-radius: 20px;
            border: 2px solid rgba(0, 170, 255, 0.5);
        }

        #mute-btn {
            pointer-events: auto; cursor: pointer;
            background: rgba(0,0,0,0.5); border: 2px solid #fff;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: #fff;
        }

        /* --- ENTRY SCREEN (To unlock Audio) --- */
        #entry-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 500;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .pulse-text { animation: pulse 1s infinite alternate; cursor: pointer; color: #0ff; font-size: 30px; }
        @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }

        /* --- SAGA MAP --- */
        #level-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 0, 20, 0.98);
            display: none; /* Hidden initially, shown after entry */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
            overflow-y: auto;
        }

        .map-title { font-size: 40px; color: #0ff; text-shadow: 0 0 10px #f0f; margin-bottom: 20px; }

        .level-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            max-width: 400px; padding: 20px;
        }

        .level-node {
            width: 70px; height: 70px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: #fff;
            background: radial-gradient(circle at 30% 30%, #ff00de, #5500aa);
            border: 4px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer; position: relative; transition: transform 0.2s;
        }
        .level-node:active { transform: scale(0.9); }
        .level-node.locked { background: #444; border-color: #777; color: #777; pointer-events: none; }
        .level-node.locked::after { content: "??"; font-size: 20px; }
        .level-node.completed { background: radial-gradient(circle at 30% 30%, #00ffaa, #008855); border-color: #ccffee; }
        .level-node.completed::after { content: "?"; position: absolute; bottom: -5px; color: #ffcc00; font-size: 20px; }

        #timer-banner {
            background: #ff4444; color: #fff; padding: 10px 30px; border-radius: 10px;
            margin-top: 20px; display: none; font-family: sans-serif;
        }

        /* --- MODAL --- */
        #modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 200;
        }
        #modal-title { font-size: 40px; color: #fff; margin-bottom: 20px; text-align:center; }
        .modal-btn {
            padding: 15px 40px; font-size: 24px; border-radius: 30px; border: none; cursor: pointer;
            font-family: 'Fredoka One', cursive; margin-top: 20px;
        }
        .btn-green { background: #0f0; color: #004400; box-shadow: 0 6px 0 #00aa00; }
        .btn-red { background: #f00; color: #440000; box-shadow: 0 6px 0 #aa0000; }

        /* --- CONTROLS --- */
        #controls {
            position: absolute; bottom: 60px; width: 100%; height: 120px;
            display: flex; justify-content: space-between; padding: 0 30px;
            box-sizing: border-box; z-index: 20; display: none;
        }
        .d-pad, .action-pad { display: flex; gap: 20px; align-items: flex-end; }
        .btn {
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 30px; touch-action: none; pointer-events: auto;
        }
        .btn:active { background: rgba(255,255,255,0.4); }

        @media (max-width: 768px) { #controls { display: flex; } }
        
        #game-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #111; color: #777; padding: 5px 0;
            text-align: center; font-size: 10px; font-family: sans-serif;
            border-top: 1px solid #333; z-index: 1000;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="entry-screen">
        <h1 style="color:#fff; font-size:40px; text-align:center;">BUBBLEONAUT<br>SAGA</h1>
        <div class="pulse-text">TAP TO START</div>
    </div>

    <div id="ui-layer">
        <div style="display:flex; gap:10px;">
            <div class="hud-text" id="scoreEl" style="display:none;">Score: 0</div>
            <div class="hud-text" id="currentLevelEl" style="display:none;">Lvl: 1</div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="hud-text" id="livesEl" style="display:none;">Lives: 3</div>
            <div id="mute-btn">AyTech Solution</div>
        </div>
    </div>

    <div id="level-screen">
        <div class="map-title">SELECT LEVEL</div>
        <div class="level-grid" id="level-grid"></div>
        <div id="timer-banner">Recharge in: 00:00</div>
        <p style="color: #aaa; font-family: sans-serif; margin-top: 20px; font-size: 12px;">AyTech Solution</p>
    </div>

    <div id="modal-overlay">
        <h1 id="modal-title">LEVEL CLEARED!</h1>
        <div id="modal-score" style="color:white; font-size:20px;">Score: 1000</div>
        <button class="modal-btn btn-green" id="modal-btn">NEXT LEVEL</button>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div class="btn" id="btn-left">?</div>
            <div class="btn" id="btn-right">?</div>
        </div>
        <div class="action-pad">
            <div class="btn" id="btn-thrust">?</div>
            <div class="btn" id="btn-shoot">?</div>
        </div>
    </div>
</div>

<div id="game-footer">
    <span>Made by <strong>AyTech Solution</strong> | 2025 Copyright. All rights reserved.</span>
</div>

<script>
    // --- VOICE ENGINE (TEXT TO SPEECH) ---
    const VoiceEngine = {
        synth: window.speechSynthesis,
        voices: [],
        
        init: function() {
            // Load voices (async in Chrome)
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => this.populateVoices();
            } else {
                this.populateVoices();
            }
        },

        populateVoices: function() {
            this.voices = this.synth.getVoices();
        },

        speak: function(text) {
            if (!this.synth) return;
            
            // Cancel any current speech
            this.synth.cancel();

            const utter = new SpeechSynthesisUtterance(text);
            
            // Attempt to find a female voice
            // Priorities: Google US English -> Microsoft Zira -> Samantha -> Any Female -> Default
            let selectedVoice = this.voices.find(v => v.name.includes('Google US English')) || 
                                this.voices.find(v => v.name.includes('Microsoft Zira')) ||
                                this.voices.find(v => v.name.includes('Samantha')) ||
                                this.voices.find(v => v.name.includes('Female'));

            if (selectedVoice) utter.voice = selectedVoice;
            
            utter.volume = 1;
            utter.rate = 1;
            utter.pitch = 1.1; // Slightly higher pitch for clearer "AI" effect
            
            this.synth.speak(utter);
        }
    };

    // --- AUDIO ENGINE (MUSIC & SFX) ---
    const AudioEngine = {
        ctx: null,
        isMuted: false,
        musicInterval: null,
        
        init: function() { 
            if(!this.ctx) { 
                this.ctx = new (window.AudioContext||window.webkitAudioContext)(); 
            }
            if(this.ctx.state === 'suspended') this.ctx.resume();
        },

        toggleMute: function() {
            this.isMuted = !this.isMuted;
            const btn = document.getElementById('mute-btn');
            if(this.isMuted) {
                this.stopMusic();
                btn.innerText = "??";
            } else {
                this.startMusic();
                btn.innerText = "??";
            }
        },

        playSFX: function(type) {
            if(this.isMuted || !this.ctx) return;
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);

            if(type === 'shoot') {
                osc.type = 'square'; osc.frequency.setValueAtTime(800, t);
                osc.frequency.exponentialRampToValueAtTime(100, t + 0.15);
                gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
                osc.start(t); osc.stop(t + 0.15);
            } else if(type === 'boom') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t);
                osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.3);
                gain.gain.setValueAtTime(0.3, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                osc.start(t); osc.stop(t + 0.3);
            } else if(type === 'win') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(523.25, t);
                osc.frequency.setValueAtTime(659.25, t + 0.1);
                gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.start(t); osc.stop(t + 0.3);
            }
        },

        startMusic: function() {
            if(this.isMuted || !this.ctx || this.musicInterval) return;
            const sequence = [261.63, 311.13, 392.00, 523.25, 392.00, 311.13, 261.63, 196.00];
            let noteIdx = 0; const noteDuration = 0.25;

            this.musicInterval = setInterval(() => {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(sequence[noteIdx], t);
                gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.05, t + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, t + noteDuration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(t); osc.stop(t + noteDuration);
                noteIdx = (noteIdx + 1) % sequence.length;
            }, noteDuration * 1000);
        },

        stopMusic: function() {
            if(this.musicInterval) { clearInterval(this.musicInterval); this.musicInterval = null; }
        }
    };

    // --- GLOBAL SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    // DOM Elements
    const entryScreen = document.getElementById('entry-screen');
    const levelScreen = document.getElementById('level-screen');
    const levelGrid = document.getElementById('level-grid');
    const modal = document.getElementById('modal-overlay');
    const timerBanner = document.getElementById('timer-banner');
    
    // ENTRY CLICK HANDLER
    entryScreen.addEventListener('click', () => {
        AudioEngine.init(); // Unlock Audio
        VoiceEngine.init(); // Unlock Voice
        
        // Wait small delay to ensure voices loaded
        setTimeout(() => {
            VoiceEngine.speak("Welcome to the game");
        }, 300);

        entryScreen.style.display = 'none';
        levelScreen.style.display = 'flex';
        renderMap();
        AudioEngine.startMusic();
    });

    document.getElementById('mute-btn').addEventListener('click', (e) => {
        e.stopPropagation(); AudioEngine.toggleMute();
    });

    // Game Variables
    const GameData = {
        maxLevels: 15,
        unlockedLevel: parseInt(localStorage.getItem('bubble_max_level')) || 1,
        
        saveProgress: function(levelCompleted) {
            if (levelCompleted >= this.unlockedLevel && this.unlockedLevel < this.maxLevels) {
                this.unlockedLevel++;
                localStorage.setItem('bubble_max_level', this.unlockedLevel);
            }
        },
        checkLockout: function() {
            const unlockTime = localStorage.getItem('bubble_unlock_time');
            if (unlockTime) {
                const now = Date.now();
                const diff = parseInt(unlockTime) - now;
                if (diff > 0) return diff;
                else { localStorage.removeItem('bubble_unlock_time'); return 0; }
            }
            return 0;
        },
        triggerLockout: function() {
            const time = Date.now() + (2 * 60 * 1000); 
            localStorage.setItem('bubble_unlock_time', time);
        }
    };

    let gameState = 'MENU';
    let currentLevel = 1;
    let score = 0;
    let gameLives = 3;
    const ship = { x:0, y:0, a:0, xv:0, yv:0, cd:0, dead:false, blink:0 };
    let asteroids = []; let lasers = []; let particles = [];
    const input = { u:false, l:false, r:false, s:false };

    // --- INPUTS ---
    const kH = (key, state, event) => {
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(key)) event.preventDefault();
        if(['ArrowUp','w','W'].includes(key)) input.u = state;
        if(['ArrowLeft','a','A'].includes(key)) input.l = state;
        if(['ArrowRight','d','D'].includes(key)) input.r = state;
        if(['Space','Enter',' '].includes(key)) input.s = state;
    };
    window.addEventListener('keydown', e => kH(e.key, true, e));
    window.addEventListener('keyup', e => kH(e.key, false, e));
    
    const touchBind = (id,k) => {
        const b=document.getElementById(id);
        const s=(e)=>{e.preventDefault(); input[k]=true;};
        const e=(ev)=>{ev.preventDefault(); input[k]=false;};
        b.addEventListener('touchstart',s,{passive:false}); b.addEventListener('touchend',e);
        b.addEventListener('mousedown',s); b.addEventListener('mouseup',e);
    };
    touchBind('btn-thrust','u'); touchBind('btn-left','l'); touchBind('btn-right','r'); touchBind('btn-shoot','s');

    // --- LOGIC ---
    function renderMap() {
        levelGrid.innerHTML = '';
        const lockoutTime = GameData.checkLockout();
        
        if (lockoutTime > 0) startTimer(lockoutTime);
        else timerBanner.style.display = 'none';

        for (let i = 1; i <= GameData.maxLevels; i++) {
            const node = document.createElement('div');
            node.className = 'level-node';
            node.innerText = i;
            if (i < GameData.unlockedLevel) {
                node.classList.add('completed');
                node.onclick = () => startGame(i);
            } else if (i === GameData.unlockedLevel) {
                if (lockoutTime > 0) node.classList.add('locked');
                else node.onclick = () => startGame(i);
            } else {
                node.classList.add('locked');
            }
            levelGrid.appendChild(node);
        }
    }

    function startTimer(timeLeft) {
        timerBanner.style.display = 'block';
        const interval = setInterval(() => {
            timeLeft -= 1000;
            if (timeLeft <= 0) {
                clearInterval(interval);
                renderMap();
                return;
            }
            const m = Math.floor(timeLeft/60000);
            const s = Math.floor((timeLeft%60000)/1000);
            timerBanner.innerText = `Recharge: ${m}:${s<10?'0'+s:s}`;
        }, 1000);
    }

    function startGame(level) {
        if(GameData.checkLockout() > 0) return;
        
        // TRIGGER: Start Voice
        VoiceEngine.speak("Start the game");
        
        currentLevel = level;
        score = 0;
        gameLives = 3;
        
        levelScreen.style.display = 'none';
        ['scoreEl','currentLevelEl','livesEl'].forEach(id=>document.getElementById(id).style.display='block');
        document.getElementById('controls').style.display = window.innerWidth <= 768 ? 'flex' : 'none';
        modal.style.display = 'none';
        
        document.getElementById('currentLevelEl').innerText = "Lvl: " + level;
        document.getElementById('livesEl').innerText = "Lives: " + gameLives;

        resetShip();
        spawnAsteroids(level);
        gameState = 'PLAYING';
        loop();
    }

    function resetShip() {
        ship.x = canvas.width/2; ship.y = canvas.height/2;
        ship.xv=0; ship.yv=0; ship.a = -Math.PI/2;
        ship.dead = false; ship.blink = 120;
        lasers = [];
    }

    function spawnAsteroids(lvl) {
        asteroids = [];
        const count = 3 + Math.floor(lvl * 1.5);
        const speedBase = 2 + (lvl * 0.5);
        for(let i=0; i<count; i++) {
            let x,y,d;
            do { x=Math.random()*canvas.width; y=Math.random()*canvas.height; d=Math.hypot(x-ship.x, y-ship.y); } while(d<200);
            asteroids.push({
                x:x, y:y,
                xv: (Math.random()-0.5)*speedBase, yv: (Math.random()-0.5)*speedBase,
                r: 30 + Math.random()*20, a: Math.random()*6.28
            });
        }
    }

    function update() {
        if (gameState !== 'PLAYING') return;

        if (!ship.dead) {
            if(input.l) ship.a -= 0.08;
            if(input.r) ship.a += 0.08;
            if(input.u) {
                ship.xv += Math.cos(ship.a)*0.2; ship.yv += Math.sin(ship.a)*0.2;
                particles.push({x:ship.x-Math.cos(ship.a)*15,y:ship.y-Math.sin(ship.a)*15,vx:(Math.random()-0.5),vy:(Math.random()-0.5),life:10,c:'#0ff'});
            }
            ship.x += ship.xv; ship.y += ship.yv;
            ship.xv *= 0.96; ship.yv *= 0.96; 
            if (ship.cd > 0) ship.cd--;
            if (input.s && ship.cd <= 0) {
                lasers.push({x:ship.x+Math.cos(ship.a)*20,y:ship.y+Math.sin(ship.a)*20,vx:Math.cos(ship.a)*10,vy:Math.sin(ship.a)*10,life:60});
                AudioEngine.playSFX('shoot');
                ship.cd = 15;
            }
        }
        wrap(ship, 20);

        lasers.forEach((l,i) => {
            l.x+=l.vx; l.y+=l.vy; l.life--; wrap(l,0);
            if(l.life<=0) lasers.splice(i,1);
        });

        asteroids.forEach((a,ai) => {
            a.x+=a.xv; a.y+=a.yv; wrap(a, a.r);
            lasers.forEach((l,li) => {
                if(Math.hypot(a.x-l.x, a.y-l.y) < a.r) {
                    AudioEngine.playSFX('boom');
                    lasers.splice(li,1); asteroids.splice(ai,1);
                    score += 100; document.getElementById('scoreEl').innerText = "Score: " + score;
                    for(let j=0;j<10;j++) particles.push({x:a.x,y:a.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:20,c:'#f0f'});
                    if(a.r > 20) {
                        asteroids.push({x:a.x,y:a.y,xv:Math.random()*4-2,yv:Math.random()*4-2,r:a.r/1.5});
                        asteroids.push({x:a.x,y:a.y,xv:Math.random()*4-2,yv:Math.random()*4-2,r:a.r/1.5});
                    }
                }
            });
            if(!ship.dead && ship.blink<=0 && Math.hypot(a.x-ship.x, a.y-ship.y) < a.r+10) {
                AudioEngine.playSFX('boom');
                ship.dead = true; gameLives--;
                document.getElementById('livesEl').innerText = "Lives: " + gameLives;
                if(gameLives > 0) setTimeout(resetShip, 1500);
                else gameOver();
            }
        });

        if(ship.blink>0) ship.blink--;
        particles.forEach((p,i) => { p.x+=p.vx; p.y+=p.vy; p.life--; if(p.life<=0) particles.splice(i,1); });

        if(asteroids.length === 0 && !ship.dead) levelComplete();
    }

    function wrap(o,pad) {
        if(o.x<-pad)o.x=canvas.width+pad; if(o.x>canvas.width+pad)o.x=-pad;
        if(o.y<-pad)o.y=canvas.height+pad; if(o.y>canvas.height+pad)o.y=-pad;
    }

    function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        if(!ship.dead && Math.floor(ship.blink/10)%2===0) {
            ctx.save(); ctx.translate(ship.x,ship.y); ctx.rotate(ship.a+1.57);
            ctx.fillStyle='#fff'; ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(10,10); ctx.lineTo(-10,10); ctx.fill();
            ctx.fillStyle='#0ff'; ctx.beginPath(); ctx.arc(0,-5,5,0,6.28); ctx.fill();
            ctx.restore();
        }
        asteroids.forEach(a => {
            ctx.fillStyle = '#768'; ctx.beginPath(); ctx.arc(a.x,a.y,a.r,0,6.28); ctx.fill();
            ctx.strokeStyle = '#f0f'; ctx.lineWidth=2; ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.beginPath(); ctx.arc(a.x-a.r*0.3,a.y-a.r*0.3,a.r*0.2,0,6.28); ctx.fill();
        });
        ctx.fillStyle = '#0ff'; lasers.forEach(l => { ctx.beginPath(); ctx.arc(l.x,l.y,5,0,6.28); ctx.fill(); });
        particles.forEach(p => { ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,3,3); });
    }

    function loop() {
        if(gameState === 'PLAYING') { update(); draw(); requestAnimationFrame(loop); }
    }

    function levelComplete() {
        gameState = 'Over';
        AudioEngine.playSFX('win');
        VoiceEngine.speak("Level Cleared");
        GameData.saveProgress(currentLevel);
        document.getElementById('modal-title').innerText = "LEVEL CLEARED!";
        document.getElementById('modal-score').innerText = "Score: " + score;
        const btn = document.getElementById('modal-btn');
        btn.innerText = "NEXT LEVEL"; btn.className = "modal-btn btn-green";
        btn.onclick = () => {
            if(currentLevel < GameData.maxLevels) startGame(currentLevel + 1);
            else returnToMap();
        };
        modal.style.display = 'flex';
    }

    function gameOver() {
        gameState = 'Over';
        
        // TRIGGER: Game Over Voice
        VoiceEngine.speak("Designed By AyTech Solution");
        
        GameData.triggerLockout();
        document.getElementById('modal-title').innerText = "OUT OF FUEL!";
        document.getElementById('modal-score').innerText = "Wait 2 mins to refill.";
        const btn = document.getElementById('modal-btn');
        btn.innerText = "BACK TO MAP"; btn.className = "modal-btn btn-red";
        btn.onclick = returnToMap;
        modal.style.display = 'flex';
    }

    function returnToMap() {
        gameState = 'MENU';
        modal.style.display = 'none';
        ['scoreEl','currentLevelEl','livesEl'].forEach(id=>document.getElementById(id).style.display='none');
        document.getElementById('controls').style.display='none';
        levelScreen.style.display = 'flex';
        renderMap();
    }
</script>
</body>
</html>
